<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€ƒç ”å•è¯</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div id="loading">
    <div class="skeleton-card">
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line"></div>
    </div>
  </div>

  <header class="header">
    <h1 class="header-title">è€ƒç ”è¯æ±‡ <span class="header-icon">ğŸ“š</span></h1>
    <div class="header-subtitle">å·²æ”¶å½•<span id="total-count">0</span>ä¸ªé«˜é¢‘è¯æ±‡</div>
  </header>

  <main class="container">
    <section class="search-section">
      <div class="input-group">
        <input type="text" id="search-input" class="ios-input" 
               placeholder="è¾“å…¥å•è¯æˆ–é‡Šä¹‰" 
               autocapitalize="none"
               autofocus
               onkeyup="handleSearchInput(event)">
        <button id="search-btn" class="ios-button">
          <i class="fas fa-search"></i>
          <span class="button-text">æ™ºèƒ½æœç´¢</span>
        </button>
      </div>
      <div id="search-feedback" class="feedback-message"></div>
    </section>

    <article class="card" id="word-container">
      <div class="card-content" id="word-content">
        <div class="skeleton-content">
          <div class="skeleton-line wide"></div>
          <div class="skeleton-line"></div>
          <div class="skeleton-line medium"></div>
          <div class="skeleton-line"></div>
        </div>
      </div>
      
      <div class="card-controls">
        <button id="prev-btn" class="ios-icon-button" title="ä¸Šä¸€ä¸ª">
          <i class="fas fa-chevron-left"></i>
        </button>
        <div class="page-indicator">
          <span id="current-index">0</span>/<span id="total-count">0</span>
        </div>
        <button id="next-btn" class="ios-icon-button" title="ä¸‹ä¸€ä¸ª">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </article>
  </main>

  <script>
    class WordManager {
      constructor() {
        this.words = []
        this.currentIndex = 0
        this.searchTerm = ''
        this.debounceTimer = null
      }

      async loadWords() {
        try {
          const response = await fetch('/get_words')
          if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`)
          this.words = await response.json()
          document.getElementById('total-count').textContent = this.words.length
          this.renderWord(0)
          this.setupEventListeners()
        } catch (error) {
          this.showFeedback(`âŒ æ•°æ®åŠ è½½å¤±è´¥: ${error.message}`, 'error')
        } finally {
          document.getElementById('loading').style.display = 'none'
        }
      }

      renderWord(index) {
        try {
          if (index < 0 || index >= this.words.length) return
          
          const word = this.words[index]
          let html = `
            <div class="word-header">
              <h3>${this.highlightText(word.head_word)}</h3>
              <div class="word-meta">
                ${word.usphone ? `
                  <span class="phonetic">
                    ç¾éŸ³: /${word.usphone}/
                    <button class="pronounce-btn" data-word="${word.head_word}" data-type="0">
                      <i class="fas fa-volume-up"></i>
                    </button>
                  </span>
                ` : ''}
                ${word.ukphone ? `
                  <span class="phonetic">
                    è‹±éŸ³: /${word.ukphone}/
                    <button class="pronounce-btn" data-word="${word.head_word}" data-type="1">
                      <i class="fas fa-volume-up"></i>
                    </button>
                  </span>
                ` : ''}
              </div>
            </div>`

          if (word.translations?.length) {
            html += `<div class="section">
              <h4><i class="fas fa-language"></i> ç¿»è¯‘</h4>
              ${word.translations.map(trans => `
                <div class="translation">
                  <span class="pos">[${trans.pos}]</span>
                  ${this.highlightText(trans.tranCn)}
                  ${trans.descCn ? `<div class="desc">${trans.descCn}</div>` : ''}
                </div>`).join('')}
            </div>`
          }

          if (word.sentences?.length) {
            html += `<div class="section">
              <h4><i class="fas fa-comment-dots"></i> ä¾‹å¥</h4>
              ${word.sentences.map(sen => `
                <div class="sentence">
                  <div class="en">${this.highlightText(sen.content)}</div>
                  <div class="cn">${sen.cn}</div>
                </div>`).join('')}
            </div>`
          }

          if (word.phrases?.length) {
            html += `<div class="section">
              <h4><i class="fas fa-link"></i> çŸ­è¯­</h4>
              ${word.phrases.map(phrase => `
                <div class="phrase">
                  <span class="phrase-en">${this.highlightText(phrase.content)}</span>
                  <span class="phrase-cn">${phrase.cn}</span>
                </div>`).join('')}
            </div>`
          }

          document.getElementById('word-content').innerHTML = html
          this.currentIndex = index
          this.updateControls()
          this.setupAudioListeners()
        } catch (error) {
          console.error('æ¸²æŸ“é”™è¯¯:', error)
          this.showFeedback('âš ï¸ å†…å®¹æ¸²æŸ“å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢', 'warning')
        }
      }

      setupAudioListeners() {
        document.querySelectorAll('.pronounce-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const word = e.target.closest('button').dataset.word
            const type = e.target.closest('button').dataset.type
            this.playPronunciation(word, type, e.target.closest('button'))
          })
        })
      }

      playPronunciation(word, type, button) {
        const originalHTML = button.innerHTML
        button.innerHTML = '<i class="fas fa-spinner fa-pulse"></i>'
        button.disabled = true

        const audioUrl = `http://dict.youdao.com/dictvoice?type=${type}&audio=${encodeURIComponent(word)}`
        const audio = new Audio(audioUrl)

        audio.addEventListener('canplaythrough', () => {
          button.innerHTML = originalHTML
          button.disabled = false
          audio.play()
        })

        audio.addEventListener('error', () => {
          button.innerHTML = '<i class="fas fa-exclamation-triangle"></i>'
          button.disabled = true
          setTimeout(() => {
            button.innerHTML = originalHTML
            button.disabled = false
          }, 2000)
          this.showFeedback('âš ï¸ å‘éŸ³åŠ è½½å¤±è´¥', 'warning')
        })
      }

      highlightText(text) {
        if (!this.searchTerm) return text
        const regex = new RegExp(`(${this.searchTerm})`, 'gi')
        return text.replace(regex, '<mark class="highlight">$1</mark>')
      }

      setupEventListeners() {
        document.getElementById('prev-btn').addEventListener('click', () => {
          if (this.currentIndex > 0) this.renderWord(--this.currentIndex)
        })

        document.getElementById('next-btn').addEventListener('click', () => {
          if (this.currentIndex < this.words.length - 1) this.renderWord(++this.currentIndex)
        })

        document.getElementById('search-btn').addEventListener('click', () => this.handleSearch())
      }

      handleSearchInput(event) {
        if (event.key === 'Enter') this.handleSearch()
        clearTimeout(this.debounceTimer)
        this.debounceTimer = setTimeout(() => this.handleSearch(), 300)
      }

      handleSearch() {
        const input = document.getElementById('search-input')
        this.searchTerm = input.value.trim().toLowerCase()
        
        if (!this.searchTerm) {
          this.showFeedback("ğŸ” è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢", 'info')
          return
        }

        const results = this.words.filter(word => 
          word.head_word.toLowerCase().includes(this.searchTerm) ||
          word.translations.some(t => t.tranCn.includes(this.searchTerm)) ||
          word.sentences.some(s => s.content.toLowerCase().includes(this.searchTerm))
        )

        if (results.length) {
          this.words = results
          this.renderWord(0)
          this.showFeedback(`âœ… æ‰¾åˆ° ${results.length} ä¸ªåŒ¹é…ç»“æœ`, 'success')
        } else {
          this.showFeedback("âŒ æœªæ‰¾åˆ°åŒ¹é…å†…å®¹ï¼Œå°è¯•å…¶ä»–å…³é”®è¯", 'error')
        }
      }

      updateControls() {
        document.getElementById('current-index').textContent = this.currentIndex + 1
        document.getElementById('prev-btn').disabled = this.currentIndex === 0
        document.getElementById('next-btn').disabled = this.currentIndex === this.words.length - 1
      }

      showFeedback(message, type) {
        const feedback = document.getElementById('search-feedback')
        feedback.className = `feedback-message ${type}`
        feedback.textContent = message
        feedback.style.opacity = 1
        setTimeout(() => feedback.style.opacity = 0, 3000)
      }
    }

    const wordApp = new WordManager()
    window.addEventListener('DOMContentLoaded', () => wordApp.loadWords())
  </script>
</body>
</html>